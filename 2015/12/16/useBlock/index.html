<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>block的原理介绍及使用 | Rookie`Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="block的使用" />
    
    <meta name="description">
<meta property="og:type" content="article">
<meta property="og:title" content="block的原理介绍及使用">
<meta property="og:url" content="http://yoursite.com/2015/12/16/useBlock/index.html">
<meta property="og:site_name" content="Rookie`Blog">
<meta property="og:description">
<meta property="og:image" content="http://7xisto.com1.z0.glb.clouddn.com/THBL15_logo.png?imageView2/1/w/600/h/200">
<meta property="og:updated_time" content="2015-12-23T11:11:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="block的原理介绍及使用">
<meta name="twitter:description">
    

    
        <link rel="alternate" href="/" title="Rookie`Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css" type="text/css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css" type="text/css">

    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script src="/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css" type="text/css">
    
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">Always believe that something wonderful is about to happen</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Hexo使用指南/">Hexo使用指南</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/iOS开发/">iOS开发</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/成长之路/">成长之路</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/生活感悟/">生活感悟</a></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">关于</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js" type="text/javascript"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/iOS开发/">iOS开发</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-useBlock" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        block的原理介绍及使用
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                <a href="/2015/12/16/useBlock/" class="article-date">
    <time datetime="2015-12-16T11:20:19.000Z" itemprop="datePublished">2015-12-16</time>
</a>
                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/block的使用/">block的使用</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p><img src="http://7xisto.com1.z0.glb.clouddn.com/THBL15_logo.png?imageView2/1/w/600/h/200"></p>
<a id="more"></a>
<p>特别声明</p>
<blockquote>
<p>本文转自<a href="https://www.zybuluo.com/MicroCai/note/51120" target="_blank" rel="external">https://www.zybuluo.com/MicroCai/note/51120</a> –  MicroCai </p>
</blockquote>
<p>最近使用到block , 虽说是会用, 但是对原理及其模糊, 和在什么情况下该注意些什么东西, 脑海中印象比较模糊, 顾整理一些资料, 方便学习和查阅吧. </p>
<h1 id="block的实现">block的实现</h1><h2 id="什么是block">什么是block</h2><p>block 顾名思义就是<code>代码块</code>，将同一逻辑的代码放在一个块，使代码更简洁紧凑，易于阅读，而且它比函数使用更方便，代码更美观，因而广受开发者欢迎。但同时 block 也是 iOS 开发中坑最多的地方之一，因此有必要了解下 block 的实现原理，知其然，更知其所以然，才能从根本上避免挖坑和踩坑。</p>
<p>需要知道的是，block 只是 Objective-C 对闭包的实现，并不是 iOS 独有的概念，在 C++、Java 等语言也有实现闭包，名称不同而已。</p>
<p>特别声明</p>
<blockquote>
<p>以下研究所用的过程代码由 clang 编译前端生成，仅作理解之用。实际上 clang 根本不会将 block 转换成人类可读的代码，它对 block 到底做了什么，谁也不知道。<br>所以，<strong><strong>切勿将过程代码当做block的实际实现，切记切记！！！</strong></strong></p>
</blockquote>
<hr>
<p>将下面的<code>test.m</code> 代码用 <code>clang</code>工具翻译 <code>test.cpp</code>代码</p>
<blockquote>
<p>clang -rewrite-objc test.m</p>
</blockquote>
<p><code>test.m 代码</code><br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> Objective-C 源码 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">void (^blk)(void) = ^&#123; printf(<span class="string">"Block\n"</span>); &#125;; </span><br><span class="line">blk();</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>test.cpp</code></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> 使用 clang 翻译后如下 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">struct __block_impl</span><br><span class="line">&#123;</span><br><span class="line">void <span class="keyword">*</span>isa;</span><br><span class="line">int Flags;</span><br><span class="line">int Reserved;</span><br><span class="line">void <span class="keyword">*</span>FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line">struct __main_block_impl_0</span><br><span class="line">&#123;</span><br><span class="line">struct __block_impl impl;</span><br><span class="line">struct __main_block_desc_0<span class="keyword">*</span> Desc;</span><br><span class="line">__main_block_impl_0(void <span class="keyword">*</span>fp, struct __main_block_desc_0 <span class="keyword">*</span>desc, int flags=0)</span><br><span class="line">&#123;</span><br><span class="line">impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">impl.Flags = flags;</span><br><span class="line">impl.FuncPtr = fp;</span><br><span class="line">Desc = desc;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 <span class="keyword">*</span>__cself)</span><br><span class="line">&#123;</span><br><span class="line">printf(<span class="string">"Block\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">static struct __main_block_desc_0</span><br><span class="line">&#123;</span><br><span class="line">size_t reserved;</span><br><span class="line">size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0) &#125;;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">void (<span class="keyword">*</span>blk)(void) = (void (<span class="keyword">*</span>)())&amp;__main_block_impl_0((void <span class="keyword">*</span>)__main_block_func_0, &amp;__main_block_desc_0_DATA);</span><br><span class="line">((void (<span class="keyword">*</span>)(__block_impl <span class="keyword">*</span>))((__block_impl <span class="keyword">*</span>)blk)-&gt;FuncPtr)((__block_impl <span class="keyword">*</span>)blk);</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着，我们逐一来看下这些函数和结构体</p>
<h2 id="block_结构体信息详解">block 结构体信息详解</h2><blockquote>
<p>struct __block_impl</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __block_impl 是 block 实现的结构体</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *isa;</span><br><span class="line"><span class="keyword">int</span> Flags;</span><br><span class="line"><span class="keyword">int</span> Reserved;</span><br><span class="line"><span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol>
<li><p><code>isa</code><br>指向实例对象，表明 block 本身也是一个 Objective-C 对象。block 的三种类型：<code>_NSConcreteStackBlock</code>、<code>_NSConcreteGlobalBlock</code>、<code>_NSConcreteMallocBlock</code>，即当代码执行时，isa 有三种值 </p>
<blockquote>
<p>impl.isa = &amp;_NSConcreteStackBlock;   // 保存在栈中的 block，当函数返回时会被销毁<br>impl.isa = &amp;_NSConcreteMallocBlock;   //保存在堆中的 block，当引用计数为 0 时会被销毁。<br>impl.isa = &amp;_NSConcreteGlobalBlock;  //全局的静态 block，不会访问任何外部变量。</p>
</blockquote>
</li>
<li><p><code>Flags</code><br>按位承载 block 的附加信息；</p>
</li>
<li><p><code>Reserved</code><br>保留变量；</p>
</li>
<li><p><code>FuncPtr</code><br>函数指针，指向 Block 要执行的函数，即{ printf(“Block\n”) };</p>
</li>
</ol>
<blockquote>
<p>struct __main_block_impl_0<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __main_block_impl_0 是 block 实现的结构体，也是 block 实现的入口</span></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">struct</span> __block_impl <span class="keyword">impl</span>;</span><br><span class="line"><span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">__main_block_impl_0(void *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line"><span class="keyword">impl</span>.Flags = flags;</span><br><span class="line"><span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">Desc = desc;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ol>
<li><p><code>impl</code><br>block 实现的结构体变量，该结构体前面已说明；</p>
</li>
<li><p><code>Desc</code><br>描述 block 的结构体变量；</p>
</li>
<li><p><code>__main_block_impl_0</code><br>结构体的构造函数，初始化结构体变量 impl、Desc；</p>
</li>
</ol>
<blockquote>
<p>static void __main_block_func_0<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __main_block_func_0 是 block 要最终要执行的函数代码</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Block\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>static struct __main_block_desc_0<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __main_block_desc_0 是 block 的描述信息结构体</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">size_t</span> reserved;</span><br><span class="line"><span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0) &#125;;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ol>
<li><p><code>reserved</code><br>结构体信息保留字段</p>
</li>
<li><p><code>Block_size</code><br>结构体大小</p>
</li>
</ol>
<p>此处已定义了一个该结构体类型的变量 __main_block_desc_0_DATA</p>
<p>##block 实现的执行流程<br><img src="http://7xisto.com1.z0.glb.clouddn.com/C75D9409-DA3C-4F41-865C-86190A7B7935.png"></p>
<h2 id="block_获取外部变量">block 获取外部变量</h2><blockquote>
<p>运行下面的代码<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> intValue = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">void</span> (^blk)(<span class="keyword">void</span>) = ^&#123; <span class="built_in">printf</span>(<span class="string">"intValue = %d\n"</span>, intValue); &#125;;</span><br><span class="line">blk();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>打印结果</p>
<blockquote>
<p>intValue = 1</p>
</blockquote>
<p>和第一段源码不同的是，这里多了个局部变量<code>intValue</code>，而且还在 block 里面获取到了。<br>通过前一段对 block 源码的学习，我们已经了解到 block 的函数定义在 main() 函数之外，那它又是如何获取 main() 里面的局部变量呢？为了解开疑惑，我们再次用 clang 重写这段代码<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __block_impl</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *isa;</span><br><span class="line"><span class="keyword">int</span> Flags;</span><br><span class="line"><span class="keyword">int</span> Reserved;</span><br><span class="line"><span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">struct</span> __block_impl impl;</span><br><span class="line"><span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line"><span class="keyword">int</span> intValue;</span><br><span class="line">__main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> _intValue, <span class="keyword">int</span> flags=<span class="number">0</span>) : intValue(_intValue)</span><br><span class="line">&#123;</span><br><span class="line">impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">impl.Flags = flags;</span><br><span class="line">impl.FuncPtr = fp;</span><br><span class="line">Desc = desc;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> intValue = __cself-&gt;intValue; <span class="comment">// bound by copy</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"intValue = %d\n"</span>, intValue);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">size_t</span> reserved;</span><br><span class="line"><span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> intValue = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, intValue);</span><br><span class="line">((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>原来 block 通过参数值传递获取到<code>intValue</code> 变量，通过函数</p>
<blockquote>
<p><strong>main_block_impl_0 (void *fp, struct </strong>main_block_desc_0 *desc, int _intValue, int flags=0) : intValue(_intValue)</p>
</blockquote>
<p>保存到<code>__main_block_impl_0</code>结构体的同名变量<code>intValue</code>，通过代码 <code>int intValue = __cself-&gt;intValue</code>; 取出 <code>intValue</code>，打印出来。</p>
<blockquote>
<p>构造函数 __main_block_impl_0 冒号后的表达式 intValue(_intValue) 的意思是，用 _intValue 初始化结构体成员变量 intValue。</p>
<p>有四种情况下应该使用初始化表达式来初始化成员：<br>1：初始化const成员<br>2：初始化引用成员<br>3：当调用基类的构造函数，而它拥有一组参数时<br>4：当调用成员类的构造函数，而它拥有一组参数时</p>
<p>参考：C++类成员冒号初始化以及构造函数内赋值: <a href="http://blog.csdn.net/zj510/article/details/8135556" target="_blank" rel="external">http://blog.csdn.net/zj510/article/details/8135556</a></p>
</blockquote>
<hr>
<h1 id="block和变量的内存管理">block和变量的内存管理</h1><p>了解了 block的实现，我们接着来聊聊 block 和变量的内存管理。将介绍可写变量、block的内存段、__block变量的内存段等内容，看完本文会对 block 和变量的内存管理有更加清晰的认识。</p>
<blockquote>
<ul>
<li>全局变量</li>
<li>全局静态变量</li>
<li>静态变量</li>
</ul>
</blockquote>
<p><code>全局变量</code> 和<code>全局静态变量</code> 由于作用域在全局，所以在 block 内访问和读写这两类变量和普通函数没什么区别，而 <code>静态变量</code> 作用域在 block 之外，是怎么对它进行读写呢？通过<code>clang</code> 工具，我们发现原来 <code>静态变量</code> 是通过指针传递，将变量传递到 block 内，所以可以修改变量值。而上文中的外部变量是通过值传递，自然没法对获取到的外部变量进行修改。由此，可以给我们一个启示，当我们需要修改外部变量时，是不是也可以像 <code>静态变量</code> 这样通过指针来修改外部变量的值呢？</p>
<p>Apple 早就为我们准备了这么一个东西 —— “__block”</p>
<h2 id="__block_说明符">__block 说明符</h2><p>按照惯例，重写一小段代码看看 __block 的真身<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> 使用 __block 的源码 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">__block int intValue = 0;</span><br><span class="line">void (^blk)(void) = ^&#123;</span><br><span class="line">intValue = 1;</span><br><span class="line">&#125;;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************* 使用 clang 翻译后如下 *************/</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *isa;</span><br><span class="line"><span class="keyword">int</span> Flags;</span><br><span class="line"><span class="keyword">int</span> Reserved;</span><br><span class="line"><span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> __Block_byref_intValue_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_intValue_0 *__forwarding;</span><br><span class="line"><span class="keyword">int</span> __flags;</span><br><span class="line"><span class="keyword">int</span> __size;</span><br><span class="line"><span class="keyword">int</span> intValue;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">struct</span> __block_impl impl;</span><br><span class="line"><span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">__Block_byref_intValue_0 *intValue; <span class="comment">// by ref</span></span><br><span class="line">__main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, __Block_byref_intValue_0 *_intValue, <span class="keyword">int</span> flags=<span class="number">0</span>) : intValue(_intValue-&gt;__forwarding)</span><br><span class="line">&#123;</span><br><span class="line">impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">impl.Flags = flags;</span><br><span class="line">impl.FuncPtr = fp;</span><br><span class="line">Desc = desc;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself)</span><br><span class="line">&#123;</span><br><span class="line">__Block_byref_intValue_0 *intValue = __cself-&gt;intValue; <span class="comment">// bound by ref</span></span><br><span class="line">(intValue-&gt;__forwarding-&gt;intValue) = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0 *dst, <span class="keyword">struct</span> __main_block_impl_0 *src)</span><br><span class="line">&#123;</span><br><span class="line">_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;intValue, (<span class="keyword">void</span>*)src-&gt;intValue, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0 *src)</span><br><span class="line">&#123;</span><br><span class="line">_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;intValue, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">size_t</span> reserved;</span><br><span class="line"><span class="keyword">size_t</span> Block_size;</span><br><span class="line"><span class="keyword">void</span> (*copy)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line"><span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123;  <span class="number">0</span>, </span><br><span class="line"><span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), </span><br><span class="line">__main_block_copy_0, </span><br><span class="line">__main_block_dispose_0</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">__attribute__((__blocks__(byref))) __Block_byref_intValue_0 \</span><br><span class="line">intValue = </span><br><span class="line">&#123;</span><br><span class="line">(<span class="keyword">void</span>*)<span class="number">0</span>,</span><br><span class="line">(__Block_byref_intValue_0 *)&amp;intValue, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="keyword">sizeof</span>(__Block_byref_intValue_0), </span><br><span class="line"><span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)()) &amp;__main_block_impl_0   \</span><br><span class="line">(</span><br><span class="line">(<span class="keyword">void</span> *)__main_block_func_0,            \</span><br><span class="line">&amp;__main_block_desc_0_DATA,              \</span><br><span class="line">(__Block_byref_intValue_0 *)&amp;intValue,  \</span><br><span class="line"><span class="number">570425344</span>                               \</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在加了<code>__block</code> 之后，代码量增加了不少，仔细查看，其实只是比原来多了</p>
<blockquote>
<ol>
<li><strong>Block_byref_intValue_0 结构体：用于封装 </strong>block 修饰的外部变量。</li>
<li>_Block_object_assign 函数：当 block 从栈拷贝到堆时，调用此函数。</li>
<li>_Block_object_dispose 函数：当 block 从堆内存释放时，调用此函数。</li>
</ol>
</blockquote>
<p>OC源码中的 <code>__block intValue</code> 翻译后变成了<code>__Block_byref_intValue_0</code>结构体指针变量 intValue，通过指针传递到 <code>block</code> 内，这与前面说的<code>静态变量</code> 的指针传递是一致的。除此之外，整体的执行流程与不加<code>__block</code> 基本一致，不再赘述。但 <code>__Block_byref_intValue_0</code> 这个结构体需特别注意下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储 __block 外部变量的结构体</span></span><br><span class="line"><span class="keyword">struct</span> __Block_byref_intValue_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *__isa; <span class="comment">// 对象指针</span></span><br><span class="line">__Block_byref_intValue_0 *__forwarding; <span class="comment">// 指向自己的指针</span></span><br><span class="line"><span class="keyword">int</span> __flags; <span class="comment">// 标志位变量</span></span><br><span class="line"><span class="keyword">int</span> __size; <span class="comment">// 结构体大小</span></span><br><span class="line"><span class="keyword">int</span> intValue; <span class="comment">// 外部变量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_1.png"><br>在已有结构体指针指向 <code>__Block_byref_intValue_0</code> 时，结构体里面还多了个<code>__forwarding</code> 指向自己的指针变量，难道不显得多余吗？一点也不，本文后面会阐述。</p>
</blockquote>
<h2 id="block_的内存管理">block 的内存管理</h2><p>在前文中，已经提到了 block 的三种类型 <code>NSConcreteGlobalBlock</code>、<code>_NSConcreteStackBlock</code>、<code>_NSConcreteMallocBlock</code>，见名知意，可以看出三种 block 在内存中的分布</p>
<blockquote>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_2.png"></p>
</blockquote>
<h3 id="_NSConcreteGlobalBlock">_NSConcreteGlobalBlock</h3><blockquote>
<p>1、当 block 字面量写在全局作用域时，即为 global block；<br>2、当 block 字面量不获取任何外部变量时，即为 global block；</p>
</blockquote>
<p>除了上述描述的两种情况，其他形式创建的 block 均为 stack block。</p>
<p>// 下面 block 虽然定义在 for 循环内，但符合第二种情况，所以也是 global block<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(^blk_t)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> rate = <span class="number">0</span>; rate &lt; <span class="number">10</span>; ++rate) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">blk_t</span> blk = ^(<span class="keyword">int</span> count)&#123;<span class="keyword">return</span> rate * count;&#125;; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>_NSConcreteGlobalBlock</code> 类型的 block 处于内存的 ROData 段，此处没有局部变量的骚扰，运行不依赖上下文，内存管理也简单的多。</p>
<h3 id="_NSConcreteStackBlock">_NSConcreteStackBlock</h3><p><code>_NSConcreteStackBlock</code> 类型的 <code>block</code>处于内存的栈区。<code>global bloc</code>k 由于处在 data 段，可以通过指针安全访问，但 <code>stack block</code>处在内存栈区，如果其变量作用域结束，这个 <code>block</code> 就被废弃，block 上的<code>__block</code> 变量也同样会被废弃。</p>
<blockquote>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_3.png"></p>
</blockquote>
<p>为了解决这个问题，block 提供了 copy 的功能，将 block 和<code>__block</code> 变量从栈拷贝到堆，就是下面要说的 <code>_NSConcreteMallocBlock</code>。</p>
<h3 id="_NSConcreteMallocBlock">_NSConcreteMallocBlock</h3><p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_4.png"></p>
<blockquote>
<p>当 block 从栈拷贝到堆后，当栈上变量作用域结束时，仍然可以继续使用 block<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impl.isa = &amp;_NSConcreteMallocBlock<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>如果你细心的观察上面的转换后的代码，会发现访问结构体 <code>__Block_byref_intValue_0</code> 内部的成员变量都是通过访问 <code>__forwarding</code>指针完成的。为了保证能正确访问栈上的<code>__block</code> 变量，进行 <code>copy</code> 操作时，会将栈上的<code>__forwarding</code>指针指向了堆上的<code>block</code>结构体实例。</p>
<hr>
<h2 id="block_的自动拷贝和手动拷贝">block 的自动拷贝和手动拷贝</h2><blockquote>
<p>在开启 ARC 时，大部分情况下编译器通常会将创建在栈上的 block 自动拷贝到堆上，只有当</p>
</blockquote>
<p>block 作为方法或函数的参数传递时，编译器不会自动调用 copy 方法；<br>但方法/函数在内部已经实现了一份拷贝了 block 参数的代码，或者如果编译器自动拷贝，那么调用者就不需再手动拷贝，比如：</p>
<blockquote>
<ul>
<li>当 <code>block</code> 作为函数返回值返回时，编译器自动将<code>block</code>作为 <code>_Block_copy</code> 函数，效果等同于 block 直接调用<code>copy</code>方法；</li>
<li>当<code>block</code> 被赋值给 <code>__strong id</code>类型的对象或 <code>block</code> 的成员变量时，编译器自动将<code>block</code> 作为 <code>_Block_copy</code> 函数，效果等同于 <code>block</code>直接调用<code>copy</code> 方法；</li>
<li>当<code>block</code>作为参数被传入方法名带有 <code>usingBlock</code> 的<code>Cocoa Framework</code> 方法或 GCD 的 API 时。这些方法会在内部对传递进来的 <code>block</code>调用 <code>copy</code> 或 <code>_Block_copy</code> 进行拷贝;</li>
</ul>
</blockquote>
<p>让我们看个 block 自动拷贝的例子<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> ARC下编译器自动拷贝block <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">typedef int (^blk_t)(int);</span><br><span class="line">blk_t func(int rate)</span><br><span class="line">&#123;</span><br><span class="line">return ^(int count)&#123;return rate <span class="keyword">*</span> count;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的 block 获取了外部变量，所以是创建在栈上，当 func 函数返回给调用者时，脱离了局部变量 rate 的作用范围，如果调用者使用这个 block 就会出问题。那 ARC 开启的情况呢？运行这个 block 一切正常。和我们的预期结果不一样，ARC 到底给 block 施了什么魔法？我们将上面的代码翻译下<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">blk_t <span class="title">func</span><span class="params">(<span class="keyword">int</span> rate)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">blk_t tmp = &amp;__func_block_impl_0(__func_block_func_0, &amp;__func_block_desc_0_DATA, rate);</span><br><span class="line">tmp = objc_retainBlock(tmp);</span><br><span class="line"><span class="function"><span class="keyword">return</span> <span class="title">objc_autoreleaseReturnValue</span><span class="params">(tmp)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>转换后出现两个新函数 <code>objc_retainBlock</code>、<code>objc_autoreleaseReturnValue</code>。如果你看过runtime 库（点此下载:<a href="http://opensource.apple.com/tarballs/objc4/objc4-493.9.tar.gz" target="_blank" rel="external">http://opensource.apple.com/tarballs/objc4/objc4-493.9.tar.gz</a>） ，在<code>runtime/objc-arr.mm</code>文件中就有这两个函数的实现：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> objc_retainBlock() 的实现 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">id objc_retainBlock(id x) </span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">#if ARR_LOGGING</span></span><br><span class="line">objc_arr_log(<span class="string">"objc_retain_block"</span>, x);</span><br><span class="line">++CompilerGenerated.blockCopies;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">return (id)_Block_copy(x);</span><br><span class="line">&#125;</span><br><span class="line">// Create a heap based copy of a Block or simply add a reference to an existing one.</span><br><span class="line">// This must be paired with Block_release to recover memory, even when running</span><br><span class="line">// under Objective-C Garbage Collection.</span><br><span class="line">BLOCK_EXPORT void <span class="keyword">*</span>_Block_copy(const void <span class="keyword">*</span>aBlock)</span><br><span class="line">__OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_3_2);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> objc_autoreleaseReturnValue() 的实现 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">id objc_autoreleaseReturnValue(id obj)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">#if SUPPORT_RETURN_AUTORELEASE</span></span><br><span class="line">assert(_pthread_getspecific_direct(AUTORELEASE_POOL_RECLAIM_KEY) == NULL);</span><br><span class="line">if (callerAcceptsFastAutorelease(__builtin_return_address(0))) &#123;</span><br><span class="line">_pthread_setspecific_direct(AUTORELEASE_POOL_RECLAIM_KEY, obj);</span><br><span class="line">return obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">return objc_autorelease(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的代码和注释，意思就很明显了，由于 <code>block</code> 字面量是创建在栈内存，通过 <code>objc_retainBlock()</code>函数拷贝到堆内存，让 <code>tmp</code> 重新指向堆上的 <code>block</code>，然后将<code>tmp</code> 所指的堆上的<code>block</code>作为一个<code>Objective-C</code> 对象放入 <code>autoreleasepool</code> 里面，从而保证了返回后的<code>block</code> 仍然可以正确执行。</p>
<p>看完了<code>block</code> 的自动拷贝，那么看看在<code>ARC</code> 下需要手动拷贝<code>block</code> 的例子</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> ARC下编译器手动拷贝block <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">- (id)getBlockArray</span><br><span class="line">&#123;</span><br><span class="line">int val = 10;</span><br><span class="line">return [[NSArray alloc] initWithObjects: </span><br><span class="line">^&#123;NSLog(<span class="comment">@"blk0:%d", val);&#125;, </span></span><br><span class="line">^&#123;NSLog(<span class="comment">@"blk1:%d", val);&#125;, nil];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个例子就了然，返回的数组里面的 block 是不可用的，需要再手动拷贝一次才可以，这个较为简单，就不作过多解释。</p>
<p>关于 block 的拷贝操作可以用一张表总结下</p>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_5.png"></p>
<hr>
<h3 id="__block_变量的内存管理">__block 变量的内存管理</h3><p>上面啰嗦一堆，这小节主要用图说话，必要时加文字说明。</p>
<ul>
<li>当 block 从栈内存被拷贝到堆内存时，<strong>block 变量的变化如下图。需要说明的是，当栈上的 block 被拷贝到堆上，堆上的 block 再次被拷贝时，对 </strong>block 变量已经没有影响了。</li>
</ul>
<blockquote>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_6.png"><br><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_7.png"></p>
</blockquote>
<ul>
<li><p>当多个 block 获取同一个 __block 变量，block 从栈被拷贝到堆时</p>
<blockquote>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_8.png"></p>
</blockquote>
</li>
<li><p>当 block 被废弃时，__block 变量被释放</p>
<blockquote>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_9.png"></p>
</blockquote>
</li>
<li><p><strong>forwarding<br>前文已经说过，当<code>block</code>从栈被拷贝到堆时，</strong>forwarding指针变量也会指向堆区的结构体。但是为什么要这么做呢？为什么要让原本指向栈区的结构体的指针，去指向堆区的结构体呢？看起来匪夷所思，实则原因很简单，要从<code>__forwarding</code> 产生的缘由说起。想想起初为什么要给<code>block</code> 添加<code>copy</code> 的功能，就是因为<code>block</code> 获取了局部变量，当要在其他地方（超出局部变量作用范围）使用这个 block 的时候，由于访问局部变量异常，导致程序崩溃。为了解决这个问题，就给 block 添加了 copy 功能。在将 block 拷贝到堆上的同时，将<code>__forwarding</code> 指针指向堆上结构体。后面如果要想使用 <code>__block</code> 变量，只要通过<code>__forwarding</code> 访问堆上变量，就不会出现程序崩溃了。</p>
</li>
</ul>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> __forwarding 的作用 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">//猜猜下面代码的打印结果？</span><br><span class="line">&#123;</span><br><span class="line">__block int val = 0;</span><br><span class="line">void (^blk)(void) = [^&#123;++val;&#125; copy];</span><br><span class="line">++val;</span><br><span class="line">blk();</span><br><span class="line">NSLog(<span class="comment">@"%d", val);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一定有很多人会猜<code>1</code>，其实打印<code>2</code>。原因很简单，当栈上的<code>bloc</code>k 被拷贝到堆上时，栈上的 <code>__forwarding</code>也会指向堆上的<code>__block</code> 变量的结构体。</p>
<p>上面的代码中<code>^{++val;}</code> 和 <code>++val</code>; 都会被转换成 <code>++(val.__forwarding-&gt;val)</code>;，堆上的 <code>val</code> 被加了两次，最后打印堆上的 <code>val</code> 为<code>2</code>。</p>
<blockquote>
<p>图解<br><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note57603_10.png"></p>
</blockquote>
<p>block 和变量的内存管理终于讲完了，看似很长，只要了解本质，其实很简单(PS: 其实我也是看的迷迷糊糊的, 似懂非懂. 留下来慢慢研究吧)</p>
<hr>
<h1 id="block和对象的内存管理">block和对象的内存管理</h1><h2 id="获取对象">获取对象</h2><p>照例先来段代码轻松下，瞧瞧 block 是怎么获取外部对象的<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> capturing objects <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">typedef void (^blk_t)(id obj);</span><br><span class="line">blk_t blk;</span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">[self captureObject];</span><br><span class="line">blk([[NSObject alloc] init]);</span><br><span class="line">blk([[NSObject alloc] init]);</span><br><span class="line">blk([[NSObject alloc] init]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)captureObject</span><br><span class="line">&#123;</span><br><span class="line">id array = [[NSMutableArray alloc] init];</span><br><span class="line">blk = [^(id obj) &#123;</span><br><span class="line">[array addObject:obj];</span><br><span class="line">NSLog(<span class="comment">@"array count = %ld", [array count]);</span></span><br><span class="line">&#125; copy];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>翻译后的关键代码摘录如下</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* a struct for the Block and some functions */</span></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">struct</span> __block_impl impl;</span><br><span class="line"><span class="keyword">struct</span> __main_block_desc_0 *Desc;</span><br><span class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> array;</span><br><span class="line">__main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">id</span> __<span class="keyword">strong</span> _array, <span class="keyword">int</span> flags=<span class="number">0</span>) : array(_array)</span><br><span class="line">&#123;</span><br><span class="line">impl<span class="variable">.isa</span> = &amp;_<span class="built_in">NSConcreteStackBlock</span>; </span><br><span class="line">impl<span class="variable">.Flags</span> = flags;</span><br><span class="line">impl<span class="variable">.FuncPtr</span> = fp;</span><br><span class="line">Desc = desc;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself, <span class="keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> array = __cself-&gt;array;</span><br><span class="line">[array addObject:obj];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"array count = %ld"</span>, [array count]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0 *dst, __main_block_impl_0 *src)</span><br><span class="line">&#123;</span><br><span class="line">_Block_object_assign(&amp;dst-&gt;array, src-&gt;array, BLOCK_FIELD_IS_OBJECT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0 *src)</span><br><span class="line">&#123;</span><br><span class="line">_Block_object_dispose(src-&gt;array, BLOCK_FIELD_IS_OBJECT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> reserved;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> Block_size;</span><br><span class="line"><span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line"><span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123;  <span class="number">0</span>,</span><br><span class="line"><span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0),</span><br><span class="line">__main_block_copy_0,</span><br><span class="line">__main_block_dispose_0</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Block literal and executing the Block */</span></span><br><span class="line">blk_t blk;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">id</span> __<span class="keyword">strong</span> array = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">blk = &amp;__main_block_impl_0(__main_block_func_0, </span><br><span class="line">&amp;__main_block_desc_0_DATA, </span><br><span class="line">array, </span><br><span class="line"><span class="number">0x22000000</span>);</span><br><span class="line">blk = [blk <span class="keyword">copy</span>];</span><br><span class="line">&#125;</span><br><span class="line">(*blk-&gt;impl<span class="variable">.FuncPtr</span>)(blk, [[<span class="built_in">NSObject</span> alloc] init]);</span><br><span class="line">(*blk-&gt;impl<span class="variable">.FuncPtr</span>)(blk, [[<span class="built_in">NSObject</span> alloc] init]);</span><br><span class="line">(*blk-&gt;impl<span class="variable">.FuncPtr</span>)(blk, [[<span class="built_in">NSObject</span> alloc] init]);</span><br></pre></td></tr></table></figure>
<p>在本例中，当变量变量作用域结束时，<code>array</code> 被废弃，强引用失效，<code>NSMutableArray</code> 类的实例对象会被释放并废弃。在这危难关头，block 及时调用了<code>copy</code> 方法，在 <code>_Block_object_assign</code> 中，将 <code>array</code>赋值给 <code>block</code> 成员变量并持有。所以上面代码可以正常运行，打印出来的 <code>array count</code>依次递增。</p>
<p>总结代码可正常运行的原因关键就在于 <code>block</code> 通过调用<code>copy</code> 方法，持有了 <code>__strong</code> 修饰的外部变量，使得外部对象在超出其作用域后得以继续存活，代码正常执行。</p>
<p>在以下情形中， block 会从栈拷贝到堆：</p>
<blockquote>
<ul>
<li>当 block 调用 copy 方法时，如果 block 在栈上，会被拷贝到堆上；</li>
<li>当 block 作为函数返回值返回时，编译器自动将 block 作为 _Block_copy 函数，效果等同于 block 直接调用 copy 方法；</li>
<li>当 block 被赋值给 __strong id 类型的对象或 block 的成员变量时，编译器自动将 block 作为 _Block_copy 函数，效果等同于 block 直接调用 copy 方法；</li>
<li>当 block 作为参数被传入方法名带有 usingBlock 的 Cocoa Framework 方法或 GCD 的 API 时。这些方法会在内部对传递进来的 block 调用 copy 或 _Block_copy 进行拷贝;<br>其实后三种情况在上篇文章block的自动拷贝已经做过说明</li>
</ul>
</blockquote>
<p>除此之外，都需要手动调用。</p>
<blockquote>
<p> <strong>__延伸阅读：Objective-C 结构体中的 </strong>strong 成员变量<em>__</em></p>
<p>注意到 <strong>main_block_impl_0 结构体有什么异常没？在 C 结构体中出现了 </strong>strong 关键字修饰的变量。</p>
<p>通常情况下， Objective-C 的编译器因为无法检测 C 结构体初始化和释放的时间，不能进行有效的内存管理，所以 Objective-C 的 C 结构体成员是不能用 <strong>strong、</strong>weak 等等这类关键字修饰。然而 runtime 库是可以在运行时检测到 block 的内存变化，如 block 何时从栈拷贝到堆，何时从堆上释放等等，所以就会出现上述结构体成员变量用 __strong 修饰的情况。</p>
</blockquote>
<h2 id="__block_变量和对象">__block 变量和对象</h2><p>__block 说明符可以修饰任何类型的自动变量。下面让我们再看个小例子，啊，愉快的代码时间又到啦。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> block 修饰对象 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">__block id obj = [[NSObject alloc] init];</span><br></pre></td></tr></table></figure>
<p>ARC 下，对象所有权修饰符默认为 <code>__strong</code>，即<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br></pre></td></tr></table></figure></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> block 修饰对象转换后的代码 <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">/<span class="keyword">*</span> struct for __block variable <span class="keyword">*</span>/</span><br><span class="line">struct __Block_byref_obj_0 </span><br><span class="line">&#123;</span><br><span class="line">void <span class="keyword">*</span>__isa;</span><br><span class="line">__Block_byref_obj_0 <span class="keyword">*</span>__forwarding;</span><br><span class="line">int __flags;</span><br><span class="line">int __size;</span><br><span class="line">void (<span class="keyword">*</span>__Block_byref_id_object_copy)(void<span class="keyword">*</span>, void<span class="keyword">*</span>);</span><br><span class="line">void (<span class="keyword">*</span>__Block_byref_id_object_dispose)(void<span class="keyword">*</span>); </span><br><span class="line">__strong id obj;</span><br><span class="line">&#125;;</span><br><span class="line">static void __Block_byref_id_object_copy_131(void <span class="keyword">*</span>dst, void <span class="keyword">*</span>src) </span><br><span class="line">&#123;</span><br><span class="line">_Block_object_assign((char<span class="keyword">*</span>)dst + 40, <span class="keyword">*</span>(void <span class="keyword">*</span> <span class="keyword">*</span>) ((char<span class="keyword">*</span>)src + 40), 131);</span><br><span class="line">&#125;</span><br><span class="line">static void __Block_byref_id_object_dispose_131(void <span class="keyword">*</span>src) </span><br><span class="line">&#123;</span><br><span class="line">_Block_object_dispose(<span class="keyword">*</span>(void <span class="keyword">*</span> <span class="keyword">*</span>) ((char<span class="keyword">*</span>)src + 40), 131);</span><br><span class="line">&#125;</span><br><span class="line">/<span class="keyword">*</span> __block variable declaration <span class="keyword">*</span>/</span><br><span class="line">__Block_byref_obj_0 obj = &#123; 0,</span><br><span class="line">&amp;obj,</span><br><span class="line">0x2000000, </span><br><span class="line">sizeof(__Block_byref_obj_0), </span><br><span class="line">__Block_byref_id_object_copy_131, </span><br><span class="line">__Block_byref_id_object_dispose_131,</span><br><span class="line">[[NSObject alloc] init]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>__block id __strong obj</code> 的作用和 <code>id __strong obj</code> 的作用十分类似。当<code>__block id __strong obj</code> 从栈上拷贝到堆上时<code>，_Block_object_assig</code>n 被调用，<code>block</code> 持有 obj；当 <code>__block id __strong obj</code>从堆上被废弃时，<code>_Block_object_dispose</code>被调用用以释放此对象，block 引用消失。</p>
<p>所以，只要是堆上的 <code>__strong</code> 修饰符修饰的 <code>__block</code>对象类型的变量，和 <code>block</code>内获取到的 <code>__strong</code> 修饰符修饰的对象类型的变量，编译器都能对它们的内存进行适当的管理。</p>
<p>如果上面的 <code>__strong</code> 换成 <code>__weak</code>，结果会怎样呢？</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> capturing __weak objects <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">typedef void (^blk_t)(id obj);</span><br><span class="line">blk_t blk;</span><br><span class="line">- (void)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">[self captureObject];</span><br><span class="line">blk([[NSObject alloc] init]);</span><br><span class="line">blk([[NSObject alloc] init]);</span><br><span class="line">blk([[NSObject alloc] init]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)captureObject</span><br><span class="line">&#123;</span><br><span class="line">id array = [[NSMutableArray alloc] init]; </span><br><span class="line">id __weak array2 = array;</span><br><span class="line">blk = [^(id obj) &#123;</span><br><span class="line">[array2 addObject:obj];</span><br><span class="line">NSLog(<span class="comment">@"array2 count = %ld", [array2 count]);</span></span><br><span class="line">&#125; copy];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果是：</p>
<blockquote>
<p>array2 count = 0<br>array2 count = 0<br>array2 count = 0</p>
</blockquote>
<p>原因很简单，array2 是弱引用，当变量作用域结束，array 所指向的对象内存被释放，array2 指向 nil，向 nil 对象发送 count 消息就返回结果 0 了。</p>
<p>如果 <strong>weak 再改成 </strong>unsafe_unretained 呢？__unsafe_unretained 修饰的对象变量指针就相当于一个普通指针。使用这个修饰符有点需要注意的地方是，当指针所指向的对象内存被释放时，指针变量不会被置为 nil。所以当使用这个修饰符时，一定要注意不要通过悬挂指针（指向被废弃内存的指针）来访问已经被废弃的对象内存，否则程序就会崩溃。</p>
<p>如果 <strong>unsafe_unretained 再改成 </strong>autoreleasing 会怎样呢？会报错，编译器并不允许你这么干！如果你这么写</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_block id __autoreleasing obj = <span class="comment">[<span class="comment">[NSObject alloc]</span> init]</span>;</span><br></pre></td></tr></table></figure>
<p>编译器就会报下面的错误，意思就是 <strong>block 和 </strong>autoreleasing 不能同时使用。<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: <span class="strong">__block variables cannot have __</span>autoreleasing ownership <span class="strong">__block id __</span>autoreleasing obj = [[NSObject alloc] init];</span><br></pre></td></tr></table></figure></p>
<h2 id="循环引用">循环引用</h2><p>千辛万苦，重头戏终于来了。block 如果使用不小心，就容易出现循环引用，导致内存泄露。到底哪里泄露了呢？通过前面的学习，各位童鞋应该有个底了，下面就让我们一起进入这泄露地区瞧瞧，哪儿出了问题！</p>
<p>愉快的代码时间到</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// ARC enabled</span><br><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> MyObject Class <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">typedef void (^blk_t)(void);</span><br><span class="line"><span class="comment">@interface MyObject : NSObject</span></span><br><span class="line">&#123;</span><br><span class="line">blk_t blk_;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">@end</span></span><br><span class="line"><span class="comment">@implementation MyObject</span></span><br><span class="line">- (id)init</span><br><span class="line">&#123;</span><br><span class="line">self = [super init];</span><br><span class="line">blk_ = ^&#123;NSLog(<span class="comment">@"self = %@", self);&#125;; </span></span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc</span><br><span class="line">&#123;</span><br><span class="line">NSLog(<span class="comment">@"dealloc");</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">@end</span></span><br><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> main function <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">id myObject = [[MyObject alloc] init]; </span><br><span class="line">NSLog(<span class="comment">@"%@", myObject);</span></span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 self 是<code>__strong</code> 修饰，在 ARC 下，当编译器自动将代码中的 block 从栈拷贝到堆时，block 会强引用和持有 self，而 self 恰好也强引用和持有了 <code>block</code>，就造成了传说中的循环引用。</p>
<p><img src="http://7xisto.com1.z0.glb.clouddn.com/image_note58470_2.png"></p>
<p>再看一个例子<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyObject</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">blk_t blk_;</span><br><span class="line"><span class="keyword">id</span> obj_; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyObject</span> </span></span><br><span class="line">- (<span class="keyword">id</span>)init</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">blk_ = ^&#123; <span class="built_in">NSLog</span>(<span class="string">@"obj_ = %@"</span>, obj_); &#125;; </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>上面的例子中，虽然没有直接使用 self，却也存在循环引用的问题。因为对于编译器来说，obj<em> 就相当于 self-&gt;obj</em>，所以上面的代码就会变成<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blk<span class="constant">_</span> = ^&#123; <span class="constant">NSLog(</span>@<span class="string">"obj_ = %@"</span>, <span class="keyword">self</span>-&gt;obj<span class="constant">_</span>); &#125;;</span><br></pre></td></tr></table></figure></p>
<p>所以这个例子只要用 __weak，在 init 方法里面加一行即可<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> __<span class="keyword">weak</span> obj = obj_;</span><br></pre></td></tr></table></figure></p>
<p>破解循环引用还有一招，使用 __block 修饰对象，在 block 内将对象置为 nil 即可，如下</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^blk_t)(<span class="keyword">void</span>);</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyObject</span> : <span class="title">NSObject</span></span></span><br><span class="line">&#123;</span><br><span class="line">blk_t blk_;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyObject</span> </span></span><br><span class="line">- (<span class="keyword">id</span>)init</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">self</span> = [<span class="keyword">super</span> init]; </span><br><span class="line">__block <span class="keyword">id</span> tmp = <span class="keyword">self</span>;</span><br><span class="line">blk_ = ^&#123; </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, tmp);</span><br><span class="line">tmp = <span class="literal">nil</span>; </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)execBlock</span><br><span class="line">&#123;</span><br><span class="line">blk_();</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)dealloc</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"dealloc"</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="keyword">int</span> main()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">id</span> object = [[MyObject alloc] init]; </span><br><span class="line">[object execBlock];</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子挺有意思的，如果执行 execBlock 方法，就没有循环引用，如果不执行就有循环引用，挺值得玩味的。一方面，使用 <strong>block 挺危险的，万一代码中不执行 block ，就造成了循环引用，而且编译器还没法检查出来；另一方面，使用 </strong>block 可以让我们通过 <strong>block 变量去控制对象的生命周期，而且有可能在一些非常老旧的 MRC 代码中，由于不支持 </strong>weak，我们可以使用此方法来代替 __unsafe_unretained，从而避免悬挂指针的问题。</p>
<p>还有个值得一提的时，在 MRC 下，使用 <strong>block 说明符也可以避免循环引用。因为当 block 从栈拷贝到堆时，</strong>block 对象类型的变量不会被 retain，没有 <strong>block 说明符的对象类型的变量则会被 retian。正是由于 </strong>block 在 ARC 和 MRC 下的巨大差异，我们在写代码时一定要区分清楚到底是 ARC 还是 MRC。</p>
<blockquote>
<p>尽管 ARC 已经如此普及，我们可能已经可以不用去管 MRC 的东西，但要有点一定要明白，ARC 和 MRC 都是基于引用计数的内存管理，其本质上是一个东西，只不过 ARC 在编译期自动化的做了内存引用计数的管理，使得系统可以在适当的时候保留内存，适当的时候释放内存。<br>循环引用到此为止，东西并不多。如果明白了之前的知识点，就会了解循环引用不过是前面知识点的自然延伸点罢了。</p>
</blockquote>
<h2 id="Copy_和_Release">Copy 和 Release</h2><p>在 ARC 下，有时需要手动拷贝和释放 block。在 MRC 下更是如此，可以直接用 copy 和 release 来拷贝和释放<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">void</span> (^<span class="keyword">blk_on_heap)(void) </span>= [<span class="keyword">blk_on_stack </span>copy]<span class="comment">; </span></span><br><span class="line">[<span class="keyword">blk_on_heap </span>release]<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>拷贝到堆后，就可以 用 retain 持有 block<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">blk_on_heap </span>retain]<span class="comment">;</span></span><br><span class="line">``</span><br><span class="line">然而如果 <span class="keyword">block </span>在栈上，使用 retain 是毫无效果的，因此推荐使用 copy 方法来持有 <span class="keyword">block。</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">block </span>是 C 语言的扩展，所以可以在 C 中使用 <span class="keyword">block </span>的语法。比如，在上面的例子中，可以直接使用 <span class="keyword">Block_copy </span>和 <span class="keyword">Block_release </span>函数来代替 copy 和 release 方法</span><br></pre></td></tr></table></figure></p>
<p>void (^blk_on_heap)(void) = Block_copy(blk_on_stack);<br>Block_release(blk_on_heap);<br>```<br>Block_copy 的作用相当于之前看到过的 _Block_copy 函数，而且 Objective-C runtime 库在运行时拷贝 block 用的就是这个函数。同理，释放 block 时，runtime 调用了 Block_release 函数。</p>
<p>最后这里有一篇总结 block 的文章的很不错，推荐大家看看：<a href="http://tanqisen.github.io/blog/2013/04/19/gcd-block-cycle-retain/" target="_blank" rel="external">http://tanqisen.github.io/blog/2013/04/19/gcd-block-cycle-retain/</a><br>block在美团iOS的实践:<a href="http://tech.meituan.com/block-in-Meituan-iOS.html" target="_blank" rel="external">http://tech.meituan.com/block-in-Meituan-iOS.html</a><br>唐巧的技术博客:<a href="http://blog.devtang.com/blog/2013/07/28/a-look-inside-blocks/" target="_blank" rel="external">http://blog.devtang.com/blog/2013/07/28/a-look-inside-blocks/</a></p>
<p>总结:虽说是转载别人的帖子过来的. 但是还是收益匪浅…. 说实话这个看起来真的是很长, 但是慢慢的屡下来. 那么还是多少有一些明白的…. </p>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://yoursite.com/2015/12/16/useBlock/" data-id="ciy06b7zc000czkwial4ijp8f" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2015/12/24/StaticLibary/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            iOS中静态库-.a文件生成和使用
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2015/10/23/DLNAIntroduce/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">DLAN是什么</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/12/13/aboutuploadAppstoreProblem/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xisto.com1.z0.glb.clouddn.com/1F91FE85-B2FC-46A2-B73D-6652DFAD856D.png?imageView2/1/w/600/h/200)" alt="上传 Appstore 错误 - ERROR ITMS-90168" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS开发/">iOS开发</a></p>
                            <p class="item-title"><a href="/2016/12/13/aboutuploadAppstoreProblem/" class="title">上传 Appstore 错误 - ERROR ITMS-90168</a></p>
                            <p class="item-date"><time datetime="2016-12-13T01:24:31.000Z" itemprop="datePublished">2016-12-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/12/05/lookmoviewforyousname/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xisto.com1.z0.glb.clouddn.com/lookmoviewforyousname1.png?imageView2/1/w/600/h/200)" alt="你的名字观后感" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/生活感悟/">生活感悟</a></p>
                            <p class="item-title"><a href="/2016/12/05/lookmoviewforyousname/" class="title">你的名字观后感</a></p>
                            <p class="item-date"><time datetime="2016-12-05T14:52:48.000Z" itemprop="datePublished">2016-12-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/12/05/xcodelins/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xisto.com1.z0.glb.clouddn.com/xcodelins.png?imageView2/1/w/600/h/200)" alt="统计整个Xcode工程代码行数" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS开发/">iOS开发</a></p>
                            <p class="item-title"><a href="/2016/12/05/xcodelins/" class="title">统计整个Xcode工程代码行数</a></p>
                            <p class="item-date"><time datetime="2016-12-05T06:20:48.000Z" itemprop="datePublished">2016-12-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/02/17/Storyboard-References/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xisto.com1.z0.glb.clouddn.com/gifblog_large_ios_automate_storyboard.jpg?imageView2/1/w/600/h/200)" alt="iOS9新特性Storyboard References" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS开发/">iOS开发</a></p>
                            <p class="item-title"><a href="/2016/02/17/Storyboard-References/" class="title">iOS9新特性Storyboard References</a></p>
                            <p class="item-date"><time datetime="2016-02-17T01:48:47.000Z" itemprop="datePublished">2016-02-17</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2015/12/24/StaticLibary/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xisto.com1.z0.glb.clouddn.com/F0093439-EBF0-40F1-B810-6D7BF25B7D9B.png?imageView2/1/w/600/h/200)" alt="iOS中静态库-.a文件生成和使用" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS开发/">iOS开发</a></p>
                            <p class="item-title"><a href="/2015/12/24/StaticLibary/" class="title">iOS中静态库-.a文件生成和使用</a></p>
                            <p class="item-date"><time datetime="2015-12-24T14:45:18.000Z" itemprop="datePublished">2015-12-24</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo使用指南/">Hexo使用指南</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS开发/">iOS开发</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/成长之路/">成长之路</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活感悟/">生活感悟</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">4</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Appstore/">Appstore</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CoreData/">CoreData</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DLNA/">DLNA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git的使用/">Git的使用</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/References/">References</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xcode/">Xcode</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/block的使用/">block的使用</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS优化/">iOS优化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS常用宏/">iOS常用宏</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ios-调试/">ios 调试</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/你的名字/">你的名字</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/博客介绍/">博客介绍</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/博客使用/">博客使用</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/国际化/">国际化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/声波传输/">声波传输</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源库和第三方/">开源库和第三方</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编码规范/">编码规范</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自动布局/">自动布局</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/静态库/">静态库</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Appstore/" style="font-size: 10px;">Appstore</a> <a href="/tags/CoreData/" style="font-size: 10px;">CoreData</a> <a href="/tags/DLNA/" style="font-size: 10px;">DLNA</a> <a href="/tags/Git的使用/" style="font-size: 15px;">Git的使用</a> <a href="/tags/References/" style="font-size: 10px;">References</a> <a href="/tags/Xcode/" style="font-size: 15px;">Xcode</a> <a href="/tags/block的使用/" style="font-size: 10px;">block的使用</a> <a href="/tags/iOS优化/" style="font-size: 10px;">iOS优化</a> <a href="/tags/iOS常用宏/" style="font-size: 10px;">iOS常用宏</a> <a href="/tags/ios-调试/" style="font-size: 10px;">ios 调试</a> <a href="/tags/你的名字/" style="font-size: 10px;">你的名字</a> <a href="/tags/动画/" style="font-size: 10px;">动画</a> <a href="/tags/博客介绍/" style="font-size: 10px;">博客介绍</a> <a href="/tags/博客使用/" style="font-size: 20px;">博客使用</a> <a href="/tags/国际化/" style="font-size: 10px;">国际化</a> <a href="/tags/声波传输/" style="font-size: 10px;">声波传输</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/开源库和第三方/" style="font-size: 10px;">开源库和第三方</a> <a href="/tags/编码规范/" style="font-size: 10px;">编码规范</a> <a href="/tags/自动布局/" style="font-size: 10px;">自动布局</a> <a href="/tags/静态库/" style="font-size: 10px;">静态库</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2017 Rookie</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://yoursite.com/2015/12/16/useBlock/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js" type="text/javascript"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js" type="text/javascript"></script>

    </div>
</body>
</html>
